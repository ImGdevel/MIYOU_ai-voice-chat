<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Dialogue Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            padding: 12px;
            font-size: 13px;
            color: #333;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #212121;
        }

        .header-info {
            font-size: 11px;
            color: #757575;
        }

        .controls {
            background: #fff;
            padding: 8px 16px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .controls button {
            padding: 6px 12px;
            background: #212121;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .controls button:hover {
            background: #424242;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .card {
            background: white;
            padding: 12px;
            border: 1px solid #e0e0e0;
        }

        .card-title {
            font-size: 11px;
            color: #757575;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .card-value {
            font-size: 24px;
            font-weight: 600;
            color: #212121;
        }

        .card-sub {
            font-size: 10px;
            color: #9e9e9e;
            margin-top: 2px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .chart-container {
            background: white;
            padding: 12px;
            border: 1px solid #e0e0e0;
        }

        .chart-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #212121;
        }

        .chart-container canvas {
            max-height: 200px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #f5f5f5;
            font-size: 11px;
        }

        th {
            background: #fafafa;
            font-weight: 600;
            color: #616161;
            text-transform: uppercase;
        }

        td {
            color: #424242;
        }

        .status-completed {
            color: #2e7d32;
        }

        .status-failed {
            color: #c62828;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RAG Dialogue Monitoring</h1>
        <div class="header-info">Last update: <span id="lastUpdate">-</span></div>
    </div>

    <div class="controls">
        <button onclick="refreshDashboard()">Refresh</button>
        <button onclick="toggleAutoRefresh()">Auto: <span id="autoRefreshStatus">ON</span></button>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <div class="card-title">Total Requests</div>
            <div class="card-value" id="totalRequests">-</div>
            <div class="card-sub">Last 1min</div>
        </div>
        <div class="card">
            <div class="card-title">Total Tokens</div>
            <div class="card-value" id="totalTokens">-</div>
            <div class="card-sub">Cost: <span id="estimatedCost">$0.00</span></div>
        </div>
        <div class="card">
            <div class="card-title">Avg Response</div>
            <div class="card-value" id="avgResponseTime">-</div>
            <div class="card-sub">milliseconds</div>
        </div>
        <div class="card">
            <div class="card-title">Slow Requests</div>
            <div class="card-value" id="slowRequests">-</div>
            <div class="card-sub">&gt; 2s</div>
        </div>
    </div>

    <div class="content-grid">
        <div class="chart-container">
            <div class="chart-title">Response Time</div>
            <canvas id="performanceChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">Stage Performance</div>
            <canvas id="stagePerformanceChart"></canvas>
        </div>
    </div>

    <div class="content-grid">
        <div class="chart-container">
            <div class="chart-title">Slow Pipelines</div>
            <div class="table-container">
                <table id="slowPipelinesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>First</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">High Token Usage</div>
            <div class="table-container">
                <table id="highTokenUsageTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Model</th>
                            <th>Tokens</th>
                            <th>Preview</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let charts = {};

        async function fetchData(endpoint) {
            const response = await fetch(endpoint);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }

        async function refreshDashboard() {
            try {
                const endTime = new Date();
                const startTime = new Date(endTime - 60 * 1000);

                const [summary, performance, slowPipelines, highTokens] = await Promise.all([
                    fetchData(`/metrics/usage/summary?startTime=${startTime.toISOString()}&endTime=${endTime.toISOString()}`),
                    fetchData(`/metrics/performance/recent?limit=50`),
                    fetchData(`/metrics/performance/slow?thresholdMillis=2000&limit=10`),
                    fetchData(`/metrics/usage/high-tokens?tokenThreshold=100&limit=10`)
                ]);

                updateSummaryCards(summary, performance);
                updatePerformanceChart(performance);
                updateStagePerformanceChart(performance);
                updateSlowPipelinesTable(slowPipelines);
                updateHighTokenUsageTable(highTokens);

                const now = new Date();
                document.getElementById('lastUpdate').textContent =
                    `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            } catch (error) {
                console.error('Dashboard refresh failed:', error);
            }
        }

        function updateSummaryCards(summary, performance) {
            document.getElementById('totalRequests').textContent = summary.totalRequests.toLocaleString();
            document.getElementById('totalTokens').textContent = summary.totalTokens.toLocaleString();

            const costPerToken = 0.00000015;
            const estimatedCost = (summary.totalTokens * costPerToken).toFixed(4);
            document.getElementById('estimatedCost').textContent = `$${estimatedCost}`;

            if (performance.length > 0) {
                const avgTime = performance.reduce((sum, p) => sum + p.totalDurationMillis, 0) / performance.length;
                document.getElementById('avgResponseTime').textContent = Math.round(avgTime).toLocaleString() + 'ms';

                const slow = performance.filter(p => p.totalDurationMillis > 2000).length;
                document.getElementById('slowRequests').textContent = slow.toLocaleString();
            }
        }

        function updatePerformanceChart(data) {
            const ctx = document.getElementById('performanceChart');
            const sortedData = data.slice().sort((a, b) => new Date(a.startedAt) - new Date(b.startedAt));

            const labels = sortedData.map(d => {
                const time = new Date(d.startedAt);
                return `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            });
            const values = sortedData.map(d => d.totalDurationMillis);

            if (!charts.performance) {
                charts.performance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            borderColor: '#424242',
                            backgroundColor: 'rgba(66, 66, 66, 0.05)',
                            tension: 0.1,
                            borderWidth: 1,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { font: { size: 10 }, color: '#757575' },
                                grid: { color: '#f5f5f5' }
                            },
                            x: {
                                ticks: { font: { size: 10 }, color: '#757575' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                charts.performance.data.labels = labels;
                charts.performance.data.datasets[0].data = values;
                charts.performance.update('none');
            }
        }

        function updateStagePerformanceChart(data) {
            const ctx = document.getElementById('stagePerformanceChart');

            const stageStats = {};
            data.forEach(pipeline => {
                pipeline.stages.forEach(stage => {
                    if (!stageStats[stage.stageName]) {
                        stageStats[stage.stageName] = { total: 0, count: 0 };
                    }
                    stageStats[stage.stageName].total += stage.durationMillis;
                    stageStats[stage.stageName].count++;
                });
            });

            const labels = Object.keys(stageStats).map(l => l.replace(/_/g, ' ').toLowerCase());
            const avgDurations = Object.keys(stageStats).map(label =>
                Math.round(stageStats[label].total / stageStats[label].count)
            );

            if (!charts.stages) {
                charts.stages = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: avgDurations,
                            backgroundColor: '#616161',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { font: { size: 10 }, color: '#757575' },
                                grid: { color: '#f5f5f5' }
                            },
                            y: {
                                ticks: { font: { size: 10 }, color: '#757575' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                charts.stages.data.labels = labels;
                charts.stages.data.datasets[0].data = avgDurations;
                charts.stages.update('none');
            }
        }

        function updateSlowPipelinesTable(data) {
            const tbody = document.querySelector('#slowPipelinesTable tbody');
            tbody.innerHTML = '';

            data.slice(0, 10).forEach(p => {
                const time = new Date(p.startedAt);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.pipelineId.substring(0, 6)}</td>
                    <td class="status-${p.status.toLowerCase()}">${p.status}</td>
                    <td>${p.totalDurationMillis}ms</td>
                    <td>${p.firstResponseLatencyMillis || '-'}ms</td>
                    <td>${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}</td>
                `;
            });
        }

        function updateHighTokenUsageTable(data) {
            const tbody = document.querySelector('#highTokenUsageTable tbody');
            tbody.innerHTML = '';

            data.slice(0, 10).forEach(u => {
                const time = new Date(u.timestamp);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${u.pipelineId.substring(0, 6)}</td>
                    <td>${u.llmUsage?.model || '-'}</td>
                    <td>${u.llmUsage?.tokenCount || 0}</td>
                    <td>${(u.userRequest?.inputPreview || '-').substring(0, 20)}</td>
                    <td>${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}</td>
                `;
            });
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('autoRefreshStatus').textContent = 'OFF';
            } else {
                autoRefreshInterval = setInterval(refreshDashboard, 5000);
                document.getElementById('autoRefreshStatus').textContent = 'ON';
            }
        }

        refreshDashboard();
        autoRefreshInterval = setInterval(refreshDashboard, 5000);
    </script>
</body>
</html>
