apiVersion: 1

groups:
  - orgId: 1
    name: MIYOU Alerts
    folder: MIYOU
    interval: 1m
    rules:
      - uid: service-down
        title: Service Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="miyou-app"}
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [1]
                    type: lt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MIYOU 서비스가 다운되었습니다"
          description: "job={{ $labels.job }} instance={{ $labels.instance }}"

      - uid: heap-memory-high
        title: High Heap Memory Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                sum(jvm_memory_used_bytes{job="miyou-app",area="heap"}) /
                sum(jvm_memory_max_bytes{job="miyou-app",area="heap"})
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [0.85]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Heap 메모리 사용률 85% 초과"
          description: "현재 사용률: {{ humanizePercentage $values.A.Value }}"

      - uid: high-error-rate
        title: High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                sum(rate(http_server_requests_seconds_count{job="miyou-app",status=~"5.."}[5m])) /
                clamp_min(sum(rate(http_server_requests_seconds_count{job="miyou-app"}[5m])), 0.001)
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [0.05]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: NoData
        execErrState: Error
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "5xx 에러율 5% 초과"
          description: "현재 에러율: {{ humanizePercentage $values.A.Value }}"

      - uid: slow-response
        title: Slow Response Time
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{job="miyou-app"}[5m])) by (le))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [2]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "P95 응답 시간 2초 초과"
          description: "현재 P95: {{ $values.A.Value }}s"

      - uid: gc-pause-high
        title: High GC Pause Time
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                rate(jvm_gc_pause_seconds_sum{job="miyou-app"}[5m]) /
                clamp_min(rate(jvm_gc_pause_seconds_count{job="miyou-app"}[5m]), 0.001)
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [0.5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "평균 GC Pause 500ms 초과"
          description: "현재 평균 GC Pause: {{ $values.A.Value }}s"

      - uid: tts-endpoint-down
        title: TTS Endpoint Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: tts_endpoint_health{job="miyou-app"}
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [0]
                    type: lt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: NoData
        execErrState: Error
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "TTS 엔드포인트 영구 장애"
          description: "endpoint={{ $labels.endpoint }} 상태: PERMANENT_FAILURE"

      - uid: cpu-high
        title: High CPU Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: process_cpu_usage{job="miyou-app"}
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: classic_conditions
              refId: C
              conditions:
                - evaluator:
                    params: [0.9]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  type: query
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Process CPU 사용률 90% 초과"
          description: "현재 CPU: {{ humanizePercentage $values.A.Value }}"
