name: CI-CD

on:
  workflow_dispatch:
    inputs:
      deploy_strategy:
        description: "앱 배포 전략"
        type: choice
        required: false
        default: blue_green
        options:
          - blue_green
          - rolling
      deploy_nginx:
        description: "Nginx 배포를 강제로 실행할지 여부"
        type: boolean
        required: false
        default: false

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: miyou-dialogue

jobs:
  detect-nginx-changes:
    runs-on: ubuntu-latest
    outputs:
      nginx_changed: ${{ steps.detect.outputs.nginx_changed }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Nginx 변경 여부 확인
        id: detect
        shell: bash
        run: |
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            if git diff --name-only HEAD^ HEAD | grep -Eq '^(deploy/nginx/|docker-compose\.app\.yml$)'; then
              echo "nginx_changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "nginx_changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "nginx_changed=false" >> "$GITHUB_OUTPUT"
          fi

  gradle-build:
    runs-on: ubuntu-latest
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Gradle 캐시 설정
        uses: gradle/actions/setup-gradle@v4

      - name: 테스트 실행
        run: ./gradlew --no-daemon :webflux-dialogue:test

      - name: JAR 빌드
        run: ./gradlew --no-daemon :webflux-dialogue:bootJar -x test

  build-and-push:
    runs-on: ubuntu-latest
    needs: gradle-build
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: QEMU 설정
        uses: docker/setup-qemu-action@v3

      - name: Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: GHCR 로그인
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 이미지 메타데이터 생성
        id: meta
        shell: bash
        run: |
          OWNER_LOWER="$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')"
          IMAGE_REF="${{ env.REGISTRY }}/${OWNER_LOWER}/${{ env.IMAGE_NAME }}:sha-${GITHUB_SHA}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${OWNER_LOWER}/${{ env.IMAGE_NAME }}:latest"
          echo "image_ref=${IMAGE_REF}" >> "$GITHUB_OUTPUT"
          echo "image_latest=${IMAGE_LATEST}" >> "$GITHUB_OUTPUT"

      - name: Docker 빌드 및 푸시
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_ref }}
            ${{ steps.meta.outputs.image_latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: 배포 시크릿 사전 검증
        shell: bash
        run: |
          test -n "${{ secrets.EC2_HOST }}" || (echo "EC2_HOST 시크릿이 비어 있습니다." >&2; exit 1)
          test -n "${{ secrets.EC2_USER }}" || (echo "EC2_USER 시크릿이 비어 있습니다." >&2; exit 1)
          test -n "${{ secrets.EC2_SSH_PRIVATE_KEY }}" || (echo "EC2_SSH_PRIVATE_KEY 시크릿이 비어 있습니다." >&2; exit 1)

      - name: SSH 키/호스트 설정 (비-RSA 파일명 사용)
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keygen -y -f ~/.ssh/deploy_key >/dev/null

          cat > ~/.ssh/config <<EOF
          Host deploy-target
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/deploy_key
            IdentitiesOnly yes
            StrictHostKeyChecking accept-new
            ServerAliveInterval 30
            ConnectTimeout 10
          EOF
          chmod 600 ~/.ssh/config

      - name: 원격 서버 GHCR 로그인
        shell: bash
        run: |
          ssh deploy-target \
            "echo '${{ secrets.GHCR_TOKEN }}' | docker login ghcr.io -u '${{ secrets.GHCR_USERNAME }}' --password-stdin"

      - name: 원격 배포 실행
        env:
          APP_IMAGE: ${{ needs.build-and-push.outputs.image_ref }}
          SSM_PATH: ${{ secrets.SSM_PATH }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        shell: bash
        run: |
          if [[ "${{ github.event.inputs.deploy_strategy }}" == "rolling" ]]; then
            ./scripts/aws/deploy_remote_compose.sh "deploy-target"
          else
            ./scripts/aws/deploy_remote_blue_green.sh "deploy-target"
          fi

  deploy_nginx:
    runs-on: ubuntu-latest
    needs:
      - deploy
      - detect-nginx-changes
    if: ${{ github.event.inputs.deploy_nginx == 'true' || needs['detect-nginx-changes'].outputs.nginx_changed == 'true' }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: 배포 시크릿 사전 검증
        shell: bash
        run: |
          test -n "${{ secrets.EC2_HOST }}" || (echo "EC2_HOST 시크릿이 비어 있습니다." >&2; exit 1)
          test -n "${{ secrets.EC2_USER }}" || (echo "EC2_USER 시크릿이 비어 있습니다." >&2; exit 1)
          test -n "${{ secrets.EC2_SSH_PRIVATE_KEY }}" || (echo "EC2_SSH_PRIVATE_KEY 시크릿이 비어 있습니다." >&2; exit 1)

      - name: SSH 키/호스트 설정 (비-RSA 파일명 사용)
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keygen -y -f ~/.ssh/deploy_key >/dev/null

          cat > ~/.ssh/config <<EOF
          Host deploy-target
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/deploy_key
            IdentitiesOnly yes
            StrictHostKeyChecking accept-new
            ServerAliveInterval 30
            ConnectTimeout 10
          EOF
          chmod 600 ~/.ssh/config

      - name: Nginx 설정 배포 실행
        shell: bash
        run: |
          bash ./scripts/aws/deploy_remote_nginx.sh "deploy-target"

  notify:
    runs-on: ubuntu-latest
    needs:
      - gradle-build
      - build-and-push
      - deploy
      - deploy_nginx
    if: always()
    steps:
      - name: 디스코드 웹훅 알림
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RESULT_GRADLE: ${{ needs.gradle-build.result }}
          RESULT_BUILD_PUSH: ${{ needs.build-and-push.result }}
          RESULT_DEPLOY: ${{ needs.deploy.result }}
          RESULT_DEPLOY_NGINX: ${{ needs.deploy_nginx.result }}
        shell: bash
        run: |
          if [[ -z "${DISCORD_WEBHOOK_URL}" ]]; then
            echo "DISCORD_WEBHOOK_URL 시크릿이 없어 알림을 건너뜁니다."
            exit 0
          fi

          if [[ "${RESULT_GRADLE}" == "success" && "${RESULT_BUILD_PUSH}" == "success" && "${RESULT_DEPLOY}" == "success" && ( "${RESULT_DEPLOY_NGINX}" == "success" || "${RESULT_DEPLOY_NGINX}" == "skipped" ) ]]; then
            STATUS_TEXT="성공"
            ICON="✅"
            COLOR=3066993
          else
            STATUS_TEXT="실패"
            ICON="❌"
            COLOR=15158332
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PAYLOAD="$(jq -n \
            --arg icon "${ICON}" \
            --arg status "${STATUS_TEXT}" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg branch "${GITHUB_REF_NAME}" \
            --arg actor "${GITHUB_ACTOR}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --arg run_url "${RUN_URL}" \
            --arg result_gradle "${RESULT_GRADLE}" \
            --arg result_build_push "${RESULT_BUILD_PUSH}" \
            --arg result_deploy "${RESULT_DEPLOY}" \
            --arg result_deploy_nginx "${RESULT_DEPLOY_NGINX}" \
            --argjson color "${COLOR}" \
            '{
              embeds: [
                {
                  title: ($icon + " MIYOU CI-CD 결과: " + $status),
                  description: "워크플로우 실행 결과 요약",
                  color: $color,
                  fields: [
                    {name: "저장소", value: $repo, inline: true},
                    {name: "브랜치", value: $branch, inline: true},
                    {name: "실행자", value: $actor, inline: true},
                    {name: "gradle-build", value: ((if $result_gradle == "success" then "✅" else "❌" end) + " " + $result_gradle), inline: true},
                    {name: "build-and-push", value: ((if $result_build_push == "success" then "✅" else "❌" end) + " " + $result_build_push), inline: true},
                    {name: "deploy", value: ((if $result_deploy == "success" then "✅" else "❌" end) + " " + $result_deploy), inline: true},
                    {name: "deploy-nginx", value: ((if $result_deploy_nginx == "success" then "✅" else "❌" end) + " " + $result_deploy_nginx), inline: true},
                    {name: "실행 링크", value: $run_url, inline: false}
                  ],
                  footer: {text: ("GitHub Actions • run_id=" + $run_id)}
                }
              ]
            }')"

          curl -sS -X POST "${DISCORD_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            --data "${PAYLOAD}"
