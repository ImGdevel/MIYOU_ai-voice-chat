name: CI-CD

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: miyou-dialogue

jobs:
  gradle-build:
    runs-on: ubuntu-latest
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Gradle 캐시 설정
        uses: gradle/actions/setup-gradle@v4

      - name: 테스트 실행
        run: ./gradlew --no-daemon :webflux-dialogue:test

      - name: JAR 빌드
        run: ./gradlew --no-daemon :webflux-dialogue:bootJar -x test

  build-and-push:
    runs-on: ubuntu-latest
    needs: gradle-build
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: QEMU 설정
        uses: docker/setup-qemu-action@v3

      - name: Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: GHCR 로그인
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 이미지 메타데이터 생성
        id: meta
        shell: bash
        run: |
          OWNER_LOWER="$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')"
          IMAGE_REF="${{ env.REGISTRY }}/${OWNER_LOWER}/${{ env.IMAGE_NAME }}:sha-${GITHUB_SHA}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${OWNER_LOWER}/${{ env.IMAGE_NAME }}:latest"
          echo "image_ref=${IMAGE_REF}" >> "$GITHUB_OUTPUT"
          echo "image_latest=${IMAGE_LATEST}" >> "$GITHUB_OUTPUT"

      - name: Docker 빌드 및 푸시
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_ref }}
            ${{ steps.meta.outputs.image_latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: SSH 키 설정
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: 원격 서버 GHCR 로그인
        shell: bash
        run: |
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "echo '${{ secrets.GHCR_TOKEN }}' | docker login ghcr.io -u '${{ secrets.GHCR_USERNAME }}' --password-stdin"

      - name: 원격 배포 실행
        env:
          APP_IMAGE: ${{ needs.build-and-push.outputs.image_ref }}
          SSM_PATH: ${{ secrets.SSM_PATH }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        shell: bash
        run: |
          ./scripts/aws/deploy_remote_compose.sh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
